---
title: This is our awesome new paper
journal: Methods in Science and Technology
manuscript: MST-0589
author:
- familyname: Smith
  firstname: John A
- familyname: Doe
  firstname: Jane Elizabeth
- familyname: Hardy
  firstname: PL
- familyname: Webber
  firstname: Matthew
show_editor: true
output:
  resp2r::response:
    keep_tex: yes
    toc: false
editor_options: 
  chunk_output_type: console
colours:
  dark:
    red: 0
    green: 0.404
    blue: 0.608
  mid:
    red: 0
    green: 0.48
    blue: 0.72
  light:
    red: 0.949
    green: 0.98
    blue: 1
  noaction:
    red: 0.5
    green: 0.5
    blue: 0.5
---


```{r include=FALSE}
# ----------------------------------------
# Customisation options
# ----------------------------------------
respondR::initialise_template()
word.document <- file.path(dirname(rstudioapi::getSourceEditorContext()$path), "response_template.docx")
# word.document <- system.file("inst", "response_template.docx", package = "respondR")
comment_font <- "standard" # (or "italics" or "bold")
response_font <- "bold" # (or "italics" or "standard")
highlight_textrevisions <- "standard" # (or "bold", "italics", "standard")
text_unchanged <- "Text unchanged"
newpage_sections <- FALSE
```

Many thanks for your thoughtful comments on our manuscript. Our responses are shown in bold font below.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, messages = FALSE, warning = FALSE)
# Make sure you have the latest versions of rmarkdown and bookdown installed
# https://gitlab.com/hrbrmstr/docxtractr

# Required libraries
library(tidyverse)
library(janitor)
library(magrittr)
library(docxtractr)

# Import response document (.docx)
doc <- docxtractr::read_docx(path = word.document)

# Table count
tbl_count <- docxtractr::docx_tbl_count(docx = doc)

# Extract table content
tbl_txt <- purrr::map(.x = 1:tbl_count, .f = ~
                        docxtractr::docx_extract_tbl(docx = doc, tbl_number = .x, header = TRUE) %>% 
                        janitor::clean_names(.))

# References
if(!tbl_txt[[tbl_count]][1]==""){
  biblio <- tbl_txt[[tbl_count]]
  tbl_txt <- tbl_txt[1:(tbl_count-1)]
  tbl_count <- tbl_count - 1
}else{
  biblio <- NULL}

# Number of editors and reviewers
tbl_types <- purrr::map_chr(.x = 1:tbl_count, .f = ~names(tbl_txt[[.x]])[1])
n_editors <- sum(tbl_types=="editor")
n_reviewers <- sum(tbl_types=="reviewer")

# Prepare headers
if(n_editors > 1) header_names <- paste(rep("editor", n_editors), 1:n_editors) else 
  header_names <- rep("editor", n_editors)
if(n_reviewers > 1) header_names <- c(header_names, paste(rep("reviewer", n_reviewers), 1:n_reviewers)) else header_names <- c(header_names, rep("reviewer", n_reviewers))
header_names <- header_names %>% stringr::str_to_title(.)

# Define terms for NA
not.applicable <- c("n/a", "na", "N/A", "NA", "Not applicable", "not applicable", "Not Applicable")
```

```{r, results = 'asis'}
#' ----------------------------------------
# SUMMARY SECTION
#' ----------------------------------------
cat(paste0("\\section{Summary}"))

# For each row in each table:
for (i in 1:tbl_count) {
  for(j in 1:nrow(tbl_txt[[i]])){
    
    # List action taken against each comment - and apply formatting
     if(tbl_txt[[i]][j, ]$action %in% not.applicable){
      action_main <- paste0("\\enspace \\xmark \\enspace ", text_unchanged)
    }else if(tbl_txt[[i]][j, ]$action == ""){
      action_main <- paste0("\\enspace\\checkmark \\enspace ", "No edits required")
    }else{
      action_main <- tbl_txt[[i]][j, ]$action
      action_main <- paste0("\\enspace \\checkmark \\enspace ", action_main)}
        
    # Create appropriate label
    if(header_names[i] %in% c("Editor", "Reviewer")){
      if(n_editors==1) label <- paste0(substr(header_names[i], 1, 1), ".", j, " \\hspace{3.5pt} | ") else
      label <- ""
      }else{
      label <- c(seq_len(n_editors), seq_len(n_reviewers))[i]
      label <- paste0(substr(header_names[i], 1, 1), label, ".", j, " | ")}
    
    # Print text
    cat(label)
    cat(paste0(action_main))
    cat("\\newline")
    cat("\\color{black}")
  }
}

#' ----------------------------------------
# MAIN DOCUMENT
#' ----------------------------------------

# For each row in each table
for (i in 1:tbl_count) {

  for(j in 1:nrow(tbl_txt[[i]])){
    
    # Create section
    if(j==1){
      if(newpage_sections){section_txt <- paste0("\\newpage \\section{", header_names[i], "}")
      }else{section_txt <- paste0("\\section{", header_names[i], "}")}
    }else{section_txt <- paste0("\\newline{}", "\\newline{}")}
    
    # Define header
    if(header_names[i] %in% c("Editor", "Reviewer")) ind <- "" else ind <- c(seq_len(n_editors), seq_len(n_reviewers))[i]
    
    # Define line number if present
    line_no <- ifelse(tbl_txt[[i]][j, ]$line=="", "Edits", paste0("L", tbl_txt[[i]][j, ]$line))
    
    # list action taken in response to reviewer comment
    if(tbl_txt[[i]][j, ]$action %in% not.applicable){
      action_txt <- paste0("\\color{noaction} \\textbf{Action: } ", text_unchanged, " \\xmark")
    }else if(tbl_txt[[i]][j, ]$action == ""){
      action_txt <- paste0("\\color{midcolour} \\textbf{Action: }No edits required")
    }else{
      action_txt <- tbl_txt[[i]][j, ]$action
      action_txt <- paste0("\\color{midcolour} \\textbf{Action: }", action_txt, " \\checkmark")}
    
    # Identify changes in the revised text 
    if(tbl_txt[[i]][j, ]$txt_orig %in% c(not.applicable, "") & tbl_txt[[i]][j, ]$txt_revised %in% c(not.applicable, "")){
      revised_txt <- "\\vspace{-15pt}"
    }else{ 
      out <- compareSentences(sentence1 = tbl_txt[[i]][j, ]$txt_orig, 
                              sentence2 = tbl_txt[[i]][j, ]$txt_revised, 
                              highlight_revisions = highlight_textrevisions)
      if(out == "") out <- paste0("\"", out, "\"")
      revised_txt <- paste0("\\color{midcolour}\\textbf{", line_no, ": }", out)}
    
    if(response_font == "bold") response_txt <- "\\bf \\underline{Response:} "
    if(response_font == "italics") response_txt <- "\\underline{Response:} \\em "
    if(response_font == "standard") response_txt <- "\\underline{Response:} "

    if(comment_font == "standard") comment_txt <- paste0(substr(header_names[i], 1, 1), ind, ".", j, " | ", tbl_txt[[i]]$comment[j])
    if(comment_font == "bold") comment_txt <- paste0("\\textbf{", substr(header_names[i], 1, 1), ind, ".", j, " | ", tbl_txt[[i]]$comment[j], "}")
    if(comment_font == "italics") comment_txt <- paste0("\\textit{", substr(header_names[i], 1, 1), ind, ".", j, " | ", tbl_txt[[i]]$comment[j], "}")
    
    # Print
    cat(section_txt)
    cat(comment_txt)
    cat("\\vspace{5pt}")
    cat("\\newline")
    cat(paste0(response_txt, tbl_txt[[i]]$response[j], "\\normalfont"))
    cat("\\par")
    cat(paste0(action_txt))
    cat("\\color{black}")
    cat("\\newline")
    cat(revised_txt)
    cat("\\color{black}")
  }
}
    cat("\\newpage")

#' ----------------------------------------
# REFERENCES
#' ----------------------------------------
    
# Print bibliography 
if(!is.null(biblio)){
  bibrefs <- data.frame(biblio)[1, 1]
  cat(paste0("\\textbf{References} "))
  cat("\\vspace{5pt}")
  cat("\\newline ")
  cat(paste0(bibrefs))}
```



